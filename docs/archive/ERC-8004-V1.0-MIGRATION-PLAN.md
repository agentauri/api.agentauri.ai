# Piano di Migrazione ERC-8004 v1.0

> **STATO: ✅ COMPLETATO** (8 Gennaio 2026)
>
> La migrazione è stata completata con successo. Ponder v1.6.1 è deployato e indicizza eventi dai contratti v1.0 su Ethereum Sepolia.
> - **163 eventi** indicizzati con successo
> - **Contratti v1.0** attivi su Ethereum Sepolia
> - **Fix ResponseAppended** applicato (commit 4ed6153)

## Executive Summary

L'aggiornamento ERC-8004 da v0.4 a v1.0 introduce **breaking changes** significativi che richiedono una migrazione completa del nostro ponder-indexer. I contratti sono stati ripuliti e ridistribuiti su Ethereum Sepolia con nuovi indirizzi.

---

## 1. Analisi delle Differenze

### 1.1 Identity Registry

| Campo/Evento | v0.4 (Attuale) | v1.0 (Nuovo) | Breaking? |
|--------------|----------------|--------------|-----------|
| `Registered` event | `tokenURI` | `agentURI` | **SI** |
| `UriUpdated` event | `newUri` | `newURI` | SI (casing) |
| `MetadataSet` event | `indexedKey`, `key`, `value` | `indexedMetadataKey`, `metadataKey`, `metadataValue` | **SI** |
| `setAgentWallet()` | Non esistente | Nuovo con EIP-712 signature | Nuova feature |

**Nuovo Contratto Sepolia:** `0x8004A818BFB912233c491871b3d84c89A494BD9e`

### 1.2 Reputation Registry

| Campo/Evento | v0.4 (Attuale) | v1.0 (Nuovo) | Breaking? |
|--------------|----------------|--------------|-----------|
| `NewFeedback.tag1` | `bytes32` | `string` | **SI** |
| `NewFeedback.tag2` | `bytes32` | `string` | **SI** |
| `NewFeedback.endpoint` | Non esistente | `string` | **SI** |
| `NewFeedback.feedbackIndex` | Non emesso | `uint64` | **SI** |
| `feedbackAuth` | Richiesto | **RIMOSSO** | **SI** |

**Nuovo Contratto Sepolia:** `0x8004B663056A597Dffe9eCcC1965A193B7388713`

### 1.3 Validation Registry

| Campo/Evento | v0.4 (Attuale) | v1.0 (Nuovo) | Breaking? |
|--------------|----------------|--------------|-----------|
| `ValidationResponse.tag` | `bytes32` | `string` | **SI** |

**Stato:** Specifica ancora in evoluzione con la community TEE. Non ancora deployato.

---

## 2. File da Modificare

### 2.1 ABIs (Alta Priorità)

```
ponder-indexers/abis/
├── IdentityRegistry.json    ← Aggiornare
├── ReputationRegistry.json  ← Aggiornare
└── ValidationRegistry.json  ← Aggiornare (quando disponibile)
```

### 2.2 Schema Ponder

```
ponder-indexers/ponder.schema.ts
```

Modifiche:
- Aggiungere campo `endpoint` per eventi NewFeedback
- Campo `feedbackIndex` ora sempre presente in NewFeedback (non più null)
- Aggiornare campo `agentUri` (rinomina da `tokenUri`)

### 2.3 Type Definitions

```
ponder-indexers/src/types.ts
```

Modifiche:
- `RegisteredEventArgs.tokenURI` → `agentURI`
- `NewFeedbackEventArgs.tag1/tag2` → `string` (non più `Hex`)
- Aggiungere `NewFeedbackEventArgs.endpoint: string`
- `NewFeedbackEventArgs.feedbackIndex: bigint` (ora emesso)
- `ValidationResponseEventArgs.tag` → `string` (non più `Hex`)

### 2.4 Event Handlers

```
ponder-indexers/src/index.ts
```

Modifiche:
- `handleRegistered`: accedere a `event.args.agentURI` invece di `tokenURI`
- `handleMetadataSet`: accedere ai nuovi nomi dei campi
- `handleNewFeedback`: gestire `endpoint`, `feedbackIndex`, e tag come stringhe
- `handleValidationResponse`: gestire `tag` come stringa

### 2.5 Validation Functions

```
ponder-indexers/src/validation.ts
```

Modifiche:
- `validateTag()`: ora accetta `string` invece di `bytes32`
- Rimuovere conversione bytes32-to-string

### 2.6 Helpers

```
ponder-indexers/src/helpers.ts
```

Modifiche:
- Aggiornare `eventValues` per includere `endpoint`
- Rinominare `tokenUri` in `agentUri`

### 2.7 Environment Config

```
ponder-indexers/src/env-validation.ts
ponder-indexers/.env.example
```

Modifiche:
- Aggiornare indirizzi contratti Sepolia di default

### 2.8 Ponder Config

```
ponder-indexers/ponder.config.ts
```

Verificare che la configurazione carichi correttamente i nuovi ABIs.

---

## 3. Nuovi Indirizzi Contratti

### Ethereum Sepolia (Deployati)

```env
ETHEREUM_SEPOLIA_IDENTITY_ADDRESS=0x8004A818BFB912233c491871b3d84c89A494BD9e
ETHEREUM_SEPOLIA_REPUTATION_ADDRESS=0x8004B663056A597Dffe9eCcC1965A193B7388713
ETHEREUM_SEPOLIA_VALIDATION_ADDRESS=TBD
```

### Altre Testnet (Pending)

- Base Sepolia: Non deployato
- Linea Sepolia: Non deployato
- Polygon Amoy: Non deployato

---

## 4. Nuove Feature da Implementare

### 4.1 Agent Wallet Verification (Identity Registry)

Nuovo evento e logica per `setAgentWallet()`:
- Verifica firma EIP-712 (EOA) o ERC-1271 (smart contract wallets)
- Campo `agentWallet` riservato nei metadata
- Reset automatico a zero address su transfer

**File coinvolti:**
- `IdentityRegistry.json` (ABI)
- `types.ts` (nuovo tipo evento)
- `index.ts` (nuovo handler)
- `ponder.schema.ts` (campo `agentWallet`)

### 4.2 Domain Verification

Supporto per verifica dominio via `/.well-known/agent-registration.json`:
- Non richiede modifiche on-chain
- Feature opzionale per validazione off-chain

### 4.3 Progressive Validation

Supporto per multiple risposte per richiesta di validazione:
- Già supportato nella nostra implementazione (eventi multipli)
- Aggiungere aggregazione per `requestHash`

### 4.4 Off-Chain Feedback JSON

Nuovo formato JSON per feedback off-chain:
- Rimosso `feedbackAuth`
- Rinominato `proof_of_payment` → `proofOfPayment`
- Aggiunto `endpoint` e `domain` (OASF-defined)

---

## 5. Piano di Esecuzione

### Fase 1: Aggiornamento ABIs (Critico)

1. [ ] Scaricare nuovi ABIs da `https://github.com/erc-8004/erc-8004-contracts/tree/master/abis`
2. [ ] Sostituire `IdentityRegistry.json`
3. [ ] Sostituire `ReputationRegistry.json`
4. [ ] Verificare `ValidationRegistry.json` (quando disponibile)

### Fase 2: Aggiornamento Schema e Types

1. [ ] Aggiornare `ponder.schema.ts`:
   - Rinominare `tokenUri` → `agentUri`
   - Aggiungere campo `endpoint`
   - Aggiornare tipo `feedbackIndex`

2. [ ] Aggiornare `types.ts`:
   - `RegisteredEventArgs.agentURI`
   - `NewFeedbackEventArgs` (tag come string, aggiungere endpoint/feedbackIndex)
   - `ValidationResponseEventArgs.tag` come string

### Fase 3: Aggiornamento Handlers

1. [ ] Aggiornare `handleRegistered()`:
   - `event.args.agentURI` invece di `tokenURI`

2. [ ] Aggiornare `handleMetadataSet()`:
   - `event.args.metadataKey` invece di `key`
   - `event.args.metadataValue` invece di `value`

3. [ ] Aggiornare `handleNewFeedback()`:
   - Tag come stringhe dirette (no conversione bytes32)
   - Aggiungere `event.args.endpoint`
   - Usare `event.args.feedbackIndex` (ora emesso)

4. [ ] Aggiornare `handleValidationResponse()`:
   - `event.args.tag` come stringa

### Fase 4: Aggiornamento Validation

1. [ ] `validateTag()`: accettare string invece di bytes32
2. [ ] Rimuovere `bytes32ToHex()` dove non più necessario
3. [ ] Aggiungere `validateEndpoint()` per nuovo campo

### Fase 5: Aggiornamento Config

1. [ ] Aggiornare indirizzi contratti in `.env`
2. [ ] Aggiornare `env-validation.ts` con nuovi default
3. [ ] Aggiornare `START_BLOCK` per nuovi contratti

### Fase 6: Testing

1. [ ] Test unitari per nuovi tipi
2. [ ] Test integrazione con Sepolia
3. [ ] Verificare indicizzazione eventi v1.0

### Fase 7: Database Migration

1. [ ] Valutare se pulire dati v0.4 (reset completo come fatto upstream)
2. [ ] Oppure mantenere backward compatibility con flag versione

---

## 6. Considerazioni sulla Migrazione

### 6.1 Storage Wipe (Upstream)

ERC-8004 v1.0 ha fatto un **complete storage wipe** dei contratti v0.4. Tutti gli agenti, reputazioni e validazioni precedenti sono stati cancellati.

**Opzioni per noi:**
1. **Reset completo**: Cancellare tutti i dati Ponder e ripartire da blocco v1.0
2. **Mantienere storico**: Tenere dati v0.4 con flag `spec_version`

**Raccomandazione:** Reset completo per allineamento con upstream.

### 6.2 Backward Compatibility

I nuovi contratti NON sono backward compatible. Non è possibile:
- Indicizzare eventi v0.4 con ABI v1.0
- Indicizzare eventi v1.0 con ABI v0.4

### 6.3 Multi-Chain Deployment

Attualmente solo Ethereum Sepolia ha contratti v1.0. Altri testnet verranno dopo:
- Base Sepolia: Pending
- Linea Sepolia: Pending
- Polygon Amoy: Pending

**Azione:** Disabilitare temporaneamente altre chain fino a deployment.

---

## 7. Rischi e Mitigazioni

| Rischio | Probabilità | Impatto | Mitigazione |
|---------|-------------|---------|-------------|
| ValidationRegistry non stabile | Alta | Medio | Non indicizzare fino a spec finale |
| ABI mismatch | Media | Alto | Test su Sepolia prima di prod |
| Perdita dati storici | Bassa | Basso | Dati v0.4 già invalidi upstream |
| Downtime indexer | Media | Medio | Blue-green deployment |

---

## 8. Timeline Suggerita

| Fase | Durata | Dipendenze |
|------|--------|------------|
| 1. Aggiornamento ABIs | 1h | Nessuna |
| 2. Schema/Types | 2h | Fase 1 |
| 3. Handlers | 2h | Fase 2 |
| 4. Validation | 1h | Fase 3 |
| 5. Config | 30min | Nessuna |
| 6. Testing | 2h | Fase 1-5 |
| 7. Deploy | 1h | Fase 6 |

**Totale stimato:** ~10 ore di lavoro

---

## 9. Nuove Opportunità

### 9.1 Subgraph Ufficiale

Il subgraph ufficiale è disponibile per Ethereum Sepolia:
```
https://gateway.thegraph.com/api/subgraphs/id/6wQRC7geo9XYAhckfmfo8kbMRLeWU8KQd3XsJqFKmZLT
```

Potremmo usarlo come fallback o per cross-validazione.

### 9.2 Agent Card Discovery

Nuovo formato per `/.well-known/agent.json`:
- Supporto x402 payment
- Endpoint multipli (A2A, MCP, ENS, DIDs)
- Trust models dichiarati

### 9.3 Genesis Month

ERC-8004 sta entrando nel "Genesis Month" - buon momento per essere early adopter su mainnet.

---

## 10. Checklist Pre-Deploy (COMPLETATA)

- [x] ABIs aggiornati
- [x] Schema aggiornato
- [x] Types aggiornati
- [x] Handlers aggiornati
- [x] Validation aggiornata
- [x] Indirizzi contratti corretti
- [x] Start block corretto (9989393)
- [x] Test su Sepolia passati
- [x] Backup database esistente
- [x] Piano rollback pronto
- [x] Fix ResponseAppended (responseUri → responseURI)

---

## Riferimenti

- [EIP-8004 Spec](https://eips.ethereum.org/EIPS/eip-8004)
- [Spec Changes Guide](https://github.com/erc-8004/erc-8004-contracts/blob/master/SpecsJan26Update.md)
- [Contracts Repo](https://github.com/erc-8004/erc-8004-contracts)
- [ABIs](https://github.com/erc-8004/erc-8004-contracts/tree/master/abis)
- [Subgraph](https://github.com/agent0lab/subgraph)
