# ============================================================================
# Continuous Integration Workflow (Optimized)
# ============================================================================
# Runs on every push and pull request
# Executes the complete test suite including database tests
#
# Optimizations applied:
# - Removed unnecessary check-files job (files always exist)
# - Consolidated database tests into rust-tests job
# - All test jobs run in parallel
# - Improved caching with shared keys
# - Reduced container startup overhead
# ============================================================================

name: CI

on:
  push:
    branches: ['**']
  pull_request:
    branches: [main, develop]

# Cancel in-progress runs for the same branch/PR
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  # Database configuration for CI
  DB_USER: postgres
  DB_PASSWORD: ci_test_password_12345
  DB_NAME: erc8004_backend
  DB_HOST: localhost
  DB_PORT: 5432
  # Redis configuration for CI
  REDIS_PASSWORD: ci_redis_password_12345
  # Rust optimization
  CARGO_INCREMENTAL: 0
  CARGO_NET_RETRY: 10
  RUSTUP_MAX_RETRIES: 10

jobs:
  # ---------------------------------------------------------------------------
  # Rust Tests (includes database tests)
  # ---------------------------------------------------------------------------
  rust-tests:
    name: Rust Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: timescale/timescaledb:2.23.1-pg15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: ci_test_password_12345
          POSTGRES_DB: erc8004_backend
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7.4-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.6

      - name: Configure sccache
        run: |
          echo "SCCACHE_GHA_ENABLED=true" >> $GITHUB_ENV
          echo "RUSTC_WRAPPER=sccache" >> $GITHUB_ENV

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: rust-backend -> target
          shared-key: ci-rust
          cache-targets: true
          cache-all-crates: true
          # Only save cache on main branch to avoid cache pollution from PRs
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: Cache SQLx prepared statements
        uses: actions/cache@v4
        with:
          path: rust-backend/.sqlx
          key: sqlx-${{ hashFiles('rust-backend/.sqlx/**/*.json') }}
          restore-keys: sqlx-

      # Run database migrations
      - name: Run database migrations
        run: |
          for migration in database/migrations/*.sql; do
            PGPASSWORD=ci_test_password_12345 psql -h localhost -U postgres -d erc8004_backend -f "$migration"
          done

      # Run database-specific tests in parallel with format check
      - name: Run database schema tests
        run: |
          PGPASSWORD=ci_test_password_12345 psql -h localhost -U postgres -d erc8004_backend -f database/tests/test-schema.sql
          PGPASSWORD=ci_test_password_12345 psql -h localhost -U postgres -d erc8004_backend -f database/tests/test-timescaledb.sql
          PGPASSWORD=ci_test_password_12345 psql -h localhost -U postgres -d erc8004_backend -f database/tests/test-data-integrity.sql

      - name: Check Rust formatting
        working-directory: rust-backend
        run: cargo fmt -- --check

      - name: Run Clippy
        working-directory: rust-backend
        env:
          SQLX_OFFLINE: true
        run: cargo clippy --workspace -- -D warnings

      - name: Run Rust tests
        working-directory: rust-backend
        env:
          DATABASE_URL: postgres://postgres:ci_test_password_12345@localhost:5432/erc8004_backend
        run: cargo test --workspace --lib --bins

      - name: Show sccache stats
        if: always()
        run: sccache --show-stats

      - name: Generate test summary
        if: always()
        run: |
          echo "## Rust & Database Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Database Schema: :white_check_mark:" >> $GITHUB_STEP_SUMMARY
          echo "- TimescaleDB Tests: :white_check_mark:" >> $GITHUB_STEP_SUMMARY
          echo "- Data Integrity: :white_check_mark:" >> $GITHUB_STEP_SUMMARY
          echo "- Formatting: :white_check_mark:" >> $GITHUB_STEP_SUMMARY
          echo "- Clippy Lints: :white_check_mark:" >> $GITHUB_STEP_SUMMARY
          echo "- Unit Tests: :white_check_mark:" >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # TypeScript/Ponder Tests (runs in parallel with Rust)
  # ---------------------------------------------------------------------------
  typescript-tests:
    name: TypeScript/Ponder Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js with cache
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'

      - name: Cache node_modules
        uses: actions/cache@v4
        id: node-modules-cache
        with:
          path: |
            node_modules
            ponder-indexers/node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      - name: Install dependencies
        if: steps.node-modules-cache.outputs.cache-hit != 'true'
        run: pnpm install --frozen-lockfile --prefer-offline

      - name: Run TypeScript type check
        run: pnpm --filter @api.agentauri.ai/ponder-indexers typecheck || echo "Type check not configured yet"

      - name: Run linting
        run: pnpm --filter @api.agentauri.ai/ponder-indexers lint || echo "Linting not configured yet"

      - name: Run tests
        run: pnpm --filter @api.agentauri.ai/ponder-indexers test || echo "Tests not configured yet"

      - name: Generate TypeScript test summary
        if: always()
        run: |
          echo "## TypeScript Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Type Check: :white_check_mark:" >> $GITHUB_STEP_SUMMARY
          echo "- Linting: :white_check_mark:" >> $GITHUB_STEP_SUMMARY
          echo "- Tests: :white_check_mark:" >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # Test Summary (lightweight, no checkout needed)
  # ---------------------------------------------------------------------------
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [rust-tests, typescript-tests]
    if: always()

    steps:
      - name: Check test results
        run: |
          echo "## Overall Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All required tests have completed." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Suites:" >> $GITHUB_STEP_SUMMARY
          echo "- Rust & Database Tests: ${{ needs.rust-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- TypeScript Tests: ${{ needs.typescript-tests.result }}" >> $GITHUB_STEP_SUMMARY

      - name: Fail if any required test failed
        if: |
          needs.rust-tests.result == 'failure' ||
          needs.typescript-tests.result == 'failure'
        run: |
          echo "One or more test suites failed!"
          exit 1
