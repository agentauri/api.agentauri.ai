# ============================================================================
# Security Scanning Workflow (Optimized)
# ============================================================================
# Runs security scans on dependencies, Docker images, and code
# Scheduled to run weekly and on pull requests
#
# Optimizations applied:
# - All independent jobs run in parallel
# - Sparse checkout where possible
# - Reduced matrix for Docker scanning (only critical images)
# - Cached cargo-audit installation
# ============================================================================

name: Security Scanning

on:
  pull_request:
    branches: [main, develop]
  schedule:
    # Run weekly on Monday at 00:00 UTC
    - cron: '0 0 * * 1'
  workflow_dispatch:

# Cancel in-progress runs for the same PR
concurrency:
  group: security-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write

jobs:
  # ---------------------------------------------------------------------------
  # Dependency Vulnerability Scan
  # ---------------------------------------------------------------------------
  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo-audit
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/cargo-audit
          key: cargo-audit-0.20

      - name: Install cargo-audit
        run: |
          if ! command -v cargo-audit &> /dev/null; then
            cargo install cargo-audit --version 0.20.0
          fi

      - name: Run npm audit
        working-directory: ponder-indexers
        continue-on-error: true
        run: |
          echo "## NPM Audit Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          npm audit --audit-level=high || echo "Vulnerabilities found - review required"
          echo "NPM audit completed. Check logs for details." >> $GITHUB_STEP_SUMMARY

      - name: Run cargo audit
        continue-on-error: true
        run: |
          echo "## Cargo Audit Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cd rust-backend
          cargo audit || echo "Vulnerabilities found - review required"
          echo "Cargo audit completed. Check logs for details." >> $GITHUB_STEP_SUMMARY

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        if: github.event_name == 'pull_request'
        with:
          fail-on-severity: high
          allow-licenses: MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC

  # ---------------------------------------------------------------------------
  # Docker Image Security Scan (reduced matrix)
  # ---------------------------------------------------------------------------
  docker-security-scan:
    name: Docker Image Security Scan
    runs-on: ubuntu-latest
    continue-on-error: true

    strategy:
      fail-fast: false
      matrix:
        image:
          # Only scan critical infrastructure images
          - timescale/timescaledb:2.23.1-pg15
          - redis:7.4-alpine

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            .github/

      - name: Set sanitized image name
        id: sanitize
        run: |
          SANITIZED=$(echo "${{ matrix.image }}" | tr '/:' '__')
          echo "filename=$SANITIZED" >> $GITHUB_OUTPUT

      - name: Pull Docker image
        run: docker pull ${{ matrix.image }}

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ matrix.image }}
          format: 'sarif'
          output: 'trivy-results-${{ steps.sanitize.outputs.filename }}.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results-${{ steps.sanitize.outputs.filename }}.sarif'
          category: 'docker-${{ steps.sanitize.outputs.filename }}'

      - name: Generate security summary
        run: |
          echo "## Docker Security Scan: ${{ matrix.image }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Trivy scan completed. Check Security tab for detailed results." >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # Dockerfile Linting
  # ---------------------------------------------------------------------------
  dockerfile-lint:
    name: Dockerfile Linting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            rust-backend/Dockerfile

      - name: Check for Dockerfiles
        id: check_dockerfiles
        run: |
          if [ -f "rust-backend/Dockerfile" ]; then
            echo "dockerfiles_exist=true" >> $GITHUB_OUTPUT
            echo "Found Dockerfiles to lint" >> $GITHUB_STEP_SUMMARY
          else
            echo "dockerfiles_exist=false" >> $GITHUB_OUTPUT
            echo "## Dockerfile Linting Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No Dockerfiles found in repository - skipping Hadolint scan." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Run Hadolint
        if: steps.check_dockerfiles.outputs.dockerfiles_exist == 'true'
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: rust-backend/Dockerfile
          failure-threshold: warning
          ignore: DL3008,DL3009

      - name: Generate Dockerfile lint summary
        if: steps.check_dockerfiles.outputs.dockerfiles_exist == 'true' && always()
        run: |
          echo "## Dockerfile Linting Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Hadolint scan completed." >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # SQL Security Analysis
  # ---------------------------------------------------------------------------
  sql-security-scan:
    name: SQL Security Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            database/

      - name: Check for SQL injection patterns
        run: |
          echo "## SQL Security Scan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if grep -r "SELECT.*||" database/ --include="*.sql" 2>/dev/null; then
            echo "Warning: String concatenation found in SQL files" >> $GITHUB_STEP_SUMMARY
            echo "Review for potential SQL injection vulnerabilities" >> $GITHUB_STEP_SUMMARY
          else
            echo "No obvious SQL injection patterns detected" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check for hardcoded credentials
        run: |
          if grep -ri "password.*=.*['\"]" database/ --include="*.sql" 2>/dev/null | grep -v "placeholder\|example\|CHANGE_THIS\|password_hash\|column_name\|test_\|ci_"; then
            echo "Warning: Potential hardcoded credentials found" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "No hardcoded credentials detected" >> $GITHUB_STEP_SUMMARY
          fi

  # ---------------------------------------------------------------------------
  # Secrets Scanning
  # ---------------------------------------------------------------------------
  secrets-scan:
    name: Secrets Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Gitleaks scan
        uses: gitleaks/gitleaks-action@v2
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate secrets scan summary
        if: always()
        run: |
          echo "## Secrets Scanning Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Gitleaks scan completed." >> $GITHUB_STEP_SUMMARY
          echo "No secrets should be committed to the repository." >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # Code Quality Analysis
  # ---------------------------------------------------------------------------
  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            .env
            .env.example

      - name: Check .env file is not committed
        run: |
          if [ -f .env ]; then
            echo "ERROR: .env file should not be committed!" >> $GITHUB_STEP_SUMMARY
            echo "Remove .env file and add it to .gitignore" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo ".env file not in repository" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Verify .env.example exists
        run: |
          if [ -f .env.example ]; then
            echo ".env.example file exists" >> $GITHUB_STEP_SUMMARY
          else
            echo "Warning: .env.example file missing" >> $GITHUB_STEP_SUMMARY
          fi

  # ---------------------------------------------------------------------------
  # Security Summary (no checkout needed)
  # ---------------------------------------------------------------------------
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [dependency-scan, docker-security-scan, dockerfile-lint, sql-security-scan, secrets-scan, code-quality]
    if: always()

    steps:
      - name: Generate security summary
        run: |
          echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Scan Results:" >> $GITHUB_STEP_SUMMARY
          echo "- Dependency Scan: ${{ needs.dependency-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Docker Security: ${{ needs.docker-security-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Dockerfile Lint: ${{ needs.dockerfile-lint.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- SQL Security: ${{ needs.sql-security-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Secrets Scan: ${{ needs.secrets-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Code Quality: ${{ needs.code-quality.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Review the Security tab for detailed vulnerability reports." >> $GITHUB_STEP_SUMMARY

      - name: Fail if critical security issues found
        if: |
          needs.secrets-scan.result == 'failure' ||
          needs.code-quality.result == 'failure'
        run: |
          echo "Critical security issues detected!"
          exit 1
